// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerkId          String             @unique
  email            String             @unique
  firstname        String?
  lastname         String?
  phone            String?            @unique
  phoneVerified    Boolean            @default(false)
  isAdmin          Boolean            @default(false)
  isInfluencer     Boolean            @default(false)
  isABusiness      Boolean            @default(false)
  createdAt        DateTime           @default(now())
  subscription     Subscription?
  integrations     Integrations[]
  automations      Automation[]
  businessHours    BusinessHours?
  businesses       Business[]
  marketingInfo    MarketingInfo[]
  scheduledContent ScheduledContent[]
  auditLogs        AuditLog[]
  sentMessages     ChatMessage[]      @relation("SentMessages")
  receivedMessages ChatMessage[]      @relation("ReceivedMessages")
  notifications    UserNotification[]
  emails           Email[]
  referredByCode   String?
  tenant           Tenant?

  leads                 Lead[]
  leadScoringRules      LeadScoringRule[]
  leadQualificationRule LeadQualificationRule[]
  leadNurturingSequence LeadNurturingSequence[]
  crmIntegration        CrmIntegration[]
  n8nWorkflows          N8nWorkflow[]
  leadTag               LeadTag[]

  handoffSettings HandoffSettings?
  handoffs        HumanHandoff[]
  responseMetrics ResponseMetrics[]

  preferences     UserPreferences?
  crmSyncSettings CrmSyncSettings?

  premiumAnalytics     PremiumAnalytics[]
  revenueMetrics       RevenueMetrics[]
  revenueOpportunities RevenueOpportunity[]

  
   socialAccounts    SocialAccount[]
   workflows         Workflows[]
   workflowAnalytics WorkflowAnalytics[]
   
   apiIntegrations   ApiIntegration[]   @relation("UserApiIntegrations")
   messageTemplates  MessageTemplates[] @relation("UserMessageTemplates")

  generalNotifications GeneralNotification[]

  webhookNotifications Notification[]
  alerts               Alert[]
  WhatsAppAccount      WhatsAppAccount[]



  
  linkedInAccounts      LinkedInAccount[]   @relation("LinkedInAccounts")
  facebookPages         FacebookPage[]      @relation("FacebookPages")
}

enum AutomationGoalType {
  PAYMENT_PROCESSING
  ECOMMERCE_INTEGRATION
  APPOINTMENT_BOOKING
  CUSTOMER_SUPPORT
  LEAD_QUALIFICATION
  CONTENT_DELIVERY
  REVIEWS_FEEDBACK
  PERSONALIZED_MARKETING
}

model AutomationGoal {
  id           String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  goalType     AutomationGoalType
  isActive     Boolean            @default(true)
  priority     Int                @default(1) // 1 = highest priority
  customConfig Json? // Store custom configuration for each goal

  // Relationships
  businessId String   @db.Uuid
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([businessId, goalType]) // Prevent duplicate goals for same business
  @@index([businessId])
  @@index([goalType])
}

model ScheduledContent {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  instagramPostId  String?     @unique
  caption          String
  mediaType        String
  mediaUrl         String
  thumbnailUrl     String?
  permalink        String?
  scheduledDate    DateTime
  publishedDate    DateTime?
  mediaProductType String?
  automation       Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId     String?     @db.Uuid
  status           String      @default("scheduled")
  User             User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String?     @db.Uuid
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
}

model MarketingInfo {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String?
  phone     String?
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @db.Uuid
}



// Add this to your existing Prisma schema

model AIAgent {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String
  avatar      String?
  agentType   String   // customer-support, sales-assistant, etc.
  isCustom    Boolean  @default(false)
  isActive    Boolean  @default(false)
  
  // Personality traits (1-10 scale)
  friendliness Int @default(5)
  formality    Int @default(5)
  enthusiasm   Int @default(5)
  empathy      Int @default(5)
  humor        Int @default(5)
  patience     Int @default(5)
  expertise    Int @default(5)
  
  // Language settings
  primaryLanguage    String  @default("English")
  detectLanguage     Boolean @default(true)
  supportedLanguages String[] // Array of language codes
  responseStyle      String  @default("professional") // casual, professional, friendly, formal
  
  tone                  String? // professional, friendly, casual, formal, enthusiastic, empathetic
  introductoryStatement String? // Custom greeting message
  
  // Relationships
  businessId String   @db.Uuid
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([businessId])
  @@index([agentType])
  @@index([isActive])
}



model Business {
  id                  String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String?
  businessName        String
  businessType        String
  businessDescription String
  automationId        String? @unique @db.Uuid

  website String

  responseLanguage String

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  automation Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  User       User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String?     @db.Uuid

  automationGoals AutomationGoal[]

  handoffs         HumanHandoff[]
  agentAssignments AgentBusinessAssignment[]
  handoffSettings  HandoffSettings[]
  agentPerformance AgentPerformance[]
  aiAgents         AIAgent[]

  generalNotifications GeneralNotification[]

  @@index([userId])
  @@index([automationId])
}

model Integrations {
  id        String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      INTEGRATIONS @default(INSTAGRAM)
  createdAt DateTime     @default(now())
  User      User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?      @db.Uuid
  token     String       @unique
  expiresAt DateTime?

  // Instagram-specific fields
  instagramId    String? @unique
  username       String?
  fullName       String?
  profilePicture String?
  followersCount Int?
  followingCount Int?
  postsCount     Int?

  // WhatsApp-specific fields
  phoneNumberId String? @unique
  phoneNumber   String?

  // Facebook-specific fields
  pageId   String? @unique
  pageName String?

  // Pinterest-specific fields
  pinterestId String? @unique
  boardCount  Int?

  // Twitter-specific fields
  twitterId  String? @unique
  tweetCount Int?

  // LinkedIn-specific fields
  linkedinId String? @unique

  // TikTok-specific fields
  tiktokId String? @unique

  lastUpdated DateTime @default(now())
}

model Automation {
  id              String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String             @default("New Automation")
  createdAt       DateTime           @default(now())
  deletedAt       DateTime?
  isFallback      Boolean            @default(false)
  active          Boolean            @default(false)
  platform        INTEGRATIONS       @default(INSTAGRAM) // Added to specify which platform this automation is for
  trigger         Trigger[]
  listenMode      String             @default("KEYWORDS") // "KEYWORDS" | "ALL_MESSAGES"
  listener        Listener?
  posts           Post[]
  leads           Lead[]
  dms             Dms[]
  messages        Message[]
  conversations   Conversation[]
  User            User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String?            @db.Uuid
  keywords        Keyword[]
  scheduledPosts  ScheduledContent[]
  handoffs        HumanHandoff[]
  responseMetrics ResponseMetrics[]

  fallbackMessage String?
  buttons         Json? // Store as JSON array

  messageTrackers             MessageTracker[]
  sentimentAnalyses           SentimentAnalysis[]
  businessProfilesDescription Business?
}


model Message {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  pageId       String
  senderId     String
  message      String
  isFromBot    Boolean
  createdAt    DateTime    @default(now())
  Automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId String?     @db.Uuid
}

model Conversation {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  pageId       String      @unique
  messages     Json[] // This will store an array of message objects
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  Automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId String?     @db.Uuid
}

model Dms {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  Automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId String?     @db.Uuid
  createdAt    DateTime    @default(now())
  senderId     String?
  reciever     String?
  message      String?
}

model Post {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  postid       String
  caption      String?
  media        String
  mediaType    MEDIATYPE   @default(IMAGE)
  Automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId String?     @db.Uuid
}

model ConversationState {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String       @unique
  isActive          Boolean      @default(false)
  lastTriggerType   String? // Track what triggered the conversation
  lastTriggerReason String? // Why it was triggered
  triggerHistory    Json? // History of triggers for this conversation
  customerType      CustomerType @default(NEW) // NEW, RETURNING, VIP
  interactionCount  Int          @default(0)
  lastInteractionAt DateTime     @default(now())
  sentiment         Float? // Overall conversation sentiment (-1 to 1)

  lastMessageLength   Int?
  averageResponseTime Float?
  isInHandoff         Boolean @default(false)
  handoffReason       String?

  automationId String? // Track which automation is handling this conversation
  listenMode   String? // Track the current listen mode

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
  @@index([customerType])
  @@index([lastInteractionAt])
}

model Listener {
  id                     String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  Automation             Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId           String     @unique @db.Uuid
  listener               LISTENERS  @default(MESSAGE)
  prompt                 String
  commentReply           String?
  commentReplyVariations String[]   @default([])
  lastComment            String?
  lastDm                 String?
  dmCount                Int        @default(0)
  commentCount           Int        @default(0)
}

model Trigger {
  id                  String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type                String // Keep existing field for backward compatibility
  triggerMode         TriggerMode @default(KEYWORD) // New field for enhanced triggers
  configuration       Json? // Store trigger-specific configuration
  priority            Int         @default(1) // Higher number = higher priority
  confidenceThreshold Float       @default(0.5) // Minimum confidence to trigger
  businessHoursOnly   Boolean     @default(false) // Only trigger during business hours
  isActive            Boolean     @default(true)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  Automation          Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId        String?     @db.Uuid

  // Relations
  executions TriggerExecution[]
  analytics  TriggerAnalytics[]

  @@index([automationId])
  @@index([triggerMode])
  @@index([isActive])
}

model Keyword {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  word         String
  Automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId String     @db.Uuid
}

enum INTEGRATIONS {
  INSTAGRAM
  WHATSAPP
  FACEBOOK
  PINTEREST
  TWITTER
  LINKEDIN
  TIKTOK
}

enum MEDIATYPE {
  IMAGE
  VIDEO
  CAROSEL_ALBUM
}

enum LISTENERS {
  SMARTAI
  MESSAGE
}

model Notification {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  type      String // email_sent, high_value_lead, lead_qualified, crm_sync, etc.
  title     String
  message   String   @db.Text
  priority  String   @default("medium") // low, medium, high, urgent
  data      Json? // Additional notification data
  leadId    String?  @db.Uuid
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead Lead? @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@index([priority])
  @@index([read])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  action    String
  target    String
  details   String?
  entityId  String?  @db.Uuid
  metadata  Json? // Store additional data like reason, instagramId
  ipAddress String?
  userAgent String?
  timestamp DateTime @default(now())

  @@map("audit_logs")
}

model Incident {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  description String
  severity    String // "low", "medium", "high", "critical"
  createdAt   DateTime  @default(now())
  resolvedAt  DateTime?
}

model ChatMessage {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  content     String
  senderId    String   @db.Uuid
  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId  String?  @db.Uuid
  receiver    User?    @relation("ReceivedMessages", fields: [receiverId], references: [id])
  isFromAdmin Boolean  @default(false)
  isPending   Boolean  @default(false)
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserNotification {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  type      String // "chat", "automation", "subscription", etc.
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MessageTemplate {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String
  content    String
  category   String?
  tags       String[]
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model EmailTemplate {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  subject     String
  content     String          @db.Text
  description String?
  category    String          @default("general")
  isDefault   Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  emails      Email[]
  campaigns   EmailCampaign[]
}

model Email {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  subject      String
  content      String         @db.Text
  recipientId  String         @db.Uuid
  recipient    User           @relation(fields: [recipientId], references: [id])
  templateId   String?        @db.Uuid
  template     EmailTemplate? @relation(fields: [templateId], references: [id])
  campaignId   String?        @db.Uuid
  campaign     EmailCampaign? @relation(fields: [campaignId], references: [id])
  status       EmailStatus    @default(SCHEDULED)
  scheduledFor DateTime?
  sentAt       DateTime?
  openedAt     DateTime?
  clickedAt    DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model EmailCampaign {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  description  String?
  templateId   String         @db.Uuid
  template     EmailTemplate  @relation(fields: [templateId], references: [id])
  status       CampaignStatus @default(DRAFT)
  scheduledFor DateTime?
  sentAt       DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  emails       Email[]
}

enum EmailStatus {
  SCHEDULED
  SENT
  FAILED
  OPENED
  CLICKED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  CANCELLED
}

// Lead Qualification Models
model Lead {
  id                   String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String                 @db.Uuid
  user                 User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  automationId         String?                @db.Uuid
  automation           Automation?            @relation(fields: [automationId], references: [id], onDelete: SetNull)
  instagramUserId      String
  pageId               String
  name                 String?
  email                String?
  phone                String?
  score                Int                    @default(0)
  status               LeadStatus             @default(NEW)
  source               String                 @default("instagram")
  firstContactDate     DateTime               @default(now())
  lastContactDate      DateTime               @default(now())
  qualifiedDate        DateTime?
  convertedDate        DateTime?
  notes                String?
  tags                 String[]
  metadata             Json?
  sentToN8n            Boolean                @default(false)
  n8nWorkflowId        String?
  n8nExecutionId       String?
  interactions         LeadInteraction[]
  revenueOpportunities RevenueOpportunity[]
  scheduledActions     ScheduledAction[]
  qualificationData    LeadQualificationData?

  notifications Notification[]
  alerts        Alert[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([instagramUserId, pageId], name: "instagramUserId_pageId")
  @@index([userId])
  @@index([automationId])
  @@index([status])
  @@index([instagramUserId])
  @@index([sentToN8n])
}

model LeadInteraction {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leadId    String   @db.Uuid
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String // message, comment, reaction
  content   String?
  direction String // inbound, outbound
  sentiment Float? // -1.0 to 1.0
  intent    Json? // Detected intents like purchase_intent, information_request
  timestamp DateTime @default(now())
  metadata  Json?

  @@index([leadId])
  @@index([timestamp])
}

model LeadQualificationData {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leadId            String   @unique @db.Uuid
  lead              Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  engagementScore   Int      @default(0)
  intentScore       Int      @default(0)
  sentimentScore    Int      @default(0)
  demographicScore  Int      @default(0)
  frequencyScore    Int      @default(0)
  recencyScore      Int      @default(0)
  revenueScore      Int?     @default(0)
  leadTier          String? // PLATINUM, GOLD, SILVER, BRONZE
  estimatedValue    Decimal? @db.Decimal(10, 2)
  roi               Decimal? @db.Decimal(5, 2)
  qualificationData Json?
  aiAnalysis        Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model LeadScoringRule {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @db.Uuid
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  ruleType    String // keyword, sentiment, frequency, recency, etc.
  condition   String // contains, equals, greater_than, etc.
  value       String // The value to compare against
  score       Int // Points to add/subtract when rule matches
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([ruleType])
}

model N8nWorkflow {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String    @db.Uuid
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  workflowId     String // ID in n8n system
  triggerUrl     String? // Webhook URL to trigger this workflow
  isActive       Boolean   @default(true)
  lastExecuted   DateTime?
  executionCount Int       @default(0)
  successCount   Int       @default(0)
  failureCount   Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([workflowId])
}

enum LeadStatus {
  NEW
  QUALIFYING
  QUALIFIED
  DISQUALIFIED
  CONVERTED
  NURTURING
  LOST
}

/////////////////////

// CRM Integration Models
model CrmIntegration {
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String            @db.Uuid
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider       CrmProvider
  name           String
  apiKey         String
  apiSecret      String?
  baseUrl        String?
  isActive       Boolean           @default(true)
  lastSynced     DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  mappings       CrmFieldMapping[]
  accessToken    String? // For OAuth integrations
  refreshToken   String? // For OAuth token refresh
  tokenExpiresAt DateTime? // Token expiration
  metadata       Json?

  @@index([userId])
  @@index([provider])
}

model CrmFieldMapping {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  integrationId     String         @db.Uuid
  integration       CrmIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  localField        String // Field in our system
  remoteField       String // Field in CRM
  isRequired        Boolean        @default(false)
  transformFunction String? // Optional JS function to transform data
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([integrationId])
}

// Enhanced Lead Qualification Models
model LeadQualificationRule {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String       @db.Uuid
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  scoreType   ScoreType    @default(OVERALL)
  operator    RuleOperator @default(GREATER_THAN)
  threshold   Int // Value to compare against
  weight      Int          @default(1) // Importance of this rule
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([userId])
  @@index([scoreType])
}

model LeadNurturingSequence {
  id          String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String              @db.Uuid
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  steps       LeadNurturingStep[]

  @@index([userId])
}

model LeadNurturingStep {
  id         String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sequenceId String                @db.Uuid
  sequence   LeadNurturingSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  stepNumber Int
  name       String
  type       NurturingStepType     @default(MESSAGE)
  content    String?
  delayDays  Int                   @default(0)
  delayHours Int                   @default(0)
  conditions Json? // Conditions for executing this step
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt

  @@index([sequenceId])
  @@index([type])
}

model LeadActivity {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leadId       String   @db.Uuid
  activityType String // email_sent, message_sent, viewed_page, etc.
  description  String?
  metadata     Json?
  timestamp    DateTime @default(now())

  @@index([leadId])
  @@index([activityType])
  @@index([timestamp])
}

model LeadTag {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  color     String   @default("#6366F1") // Default indigo color
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

// Enums for the new models
enum WorkflowType {
  LEAD_QUALIFICATION
  LEAD_NURTURING
  CRM_SYNC
  NOTIFICATION
  CUSTOM
}

enum CrmProvider {
  HUBSPOT
  SALESFORCE
  ZOHO
  PIPEDRIVE
  AIRTABLE
  NOTION
  CUSTOM
}

enum ScoreType {
  OVERALL
  ENGAGEMENT
  INTENT
  SENTIMENT
  FREQUENCY
  RECENCY
}

enum RuleOperator {
  GREATER_THAN
  LESS_THAN
  EQUAL_TO
  GREATER_THAN_OR_EQUAL
  LESS_THAN_OR_EQUAL
}

enum NurturingStepType {
  MESSAGE
  EMAIL
  WEBHOOK
  DELAY
  CONDITION
  CRM_UPDATE
}

enum SUBSCRIPTION_PLAN {
  FREE
  PRO
  ENTERPRISE
}

enum SUBSCRIPTION_STATUS {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  INCOMPLETE
  TRIALING
}

// prisma/schema.prisma - Updated Subscription model
model Subscription {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  User      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?  @unique @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  plan   SUBSCRIPTION_PLAN   @default(FREE)
  status SUBSCRIPTION_STATUS @default(ACTIVE)

  // Customer ID (shared between Stripe and Lemon Squeezy)
  customerId String? @unique

  // Stripe specific fields (keep for migration)
  stripeSubscriptionId     String?   @unique
  stripePriceId            String?
  stripeCurrentPeriodStart DateTime?
  stripeCurrentPeriodEnd   DateTime?

  // Lemon Squeezy specific fields
  lemonSqueezySubscriptionId     String?   @unique
  lemonSqueezyVariantId          String?
  lemonSqueezyCurrentPeriodStart DateTime?
  lemonSqueezyCurrentPeriodEnd   DateTime?

  // Payment method info (mainly for Stripe, but can be used for reference)
  paymentMethodId    String?
  paymentMethodType  String?
  paymentMethodLast4 String?

  paymentProvider    String?
  orderTrackingId    String?

  // Trial information
  trialStart DateTime?
  trialEnd   DateTime?

  // Cancellation fields
  cancelAtPeriodEnd Boolean   @default(false)
  canceledAt        DateTime?

  // Additional Lemon Squeezy fields
  productName   String? // e.g., "Pro Plan"
  variantName   String? // e.g., "Monthly", "Yearly"
  price         String? // e.g., "$49.99"
  interval      String? // e.g., "month", "year"
  intervalCount Int?    @default(1) // e.g., 1 for every month, 3 for every 3 months
}

/////NEWESSST

model TriggerExecution {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  triggerId      String      @db.Uuid
  trigger        Trigger     @relation(fields: [triggerId], references: [id], onDelete: Cascade)
  automationId   String      @db.Uuid
  userId         String      @db.Uuid
  messageContent String // The message that triggered this
  triggerType    TriggerMode
  confidence     Float? // Confidence score (0-1)
  reason         String? // Why this trigger fired
  success        Boolean     @default(false)
  responseTime   Int? // Time to process in milliseconds
  errorMessage   String?
  metadata       Json? // Additional execution data
  timestamp      DateTime    @default(now())

  @@index([triggerId])
  @@index([automationId])
  @@index([userId])
  @@index([triggerType])
  @@index([timestamp])
}

model TriggerAnalytics {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  triggerId            String   @db.Uuid
  trigger              Trigger  @relation(fields: [triggerId], references: [id], onDelete: Cascade)
  date                 DateTime @default(now())
  totalExecutions      Int      @default(0)
  successfulExecutions Int      @default(0)
  failedExecutions     Int      @default(0)
  averageConfidence    Float? // Average confidence score
  averageResponseTime  Int? // Average response time in ms
  spamFiltered         Int      @default(0) // Messages filtered as spam
  conversionRate       Float? // Percentage that led to meaningful conversations

  @@unique([triggerId, date])
  @@index([triggerId])
  @@index([date])
}

model AIAnalysisCache {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageHash      String   @unique // Hash of the message content
  analysis         Json // Cached AI analysis result
  confidence       Float // Confidence score from AI
  intent           String? // Detected intent
  sentiment        Float? // Sentiment score
  isSpam           Boolean  @default(false)
  businessRelevant Boolean  @default(true)
  expiresAt        DateTime // Cache expiration
  createdAt        DateTime @default(now())

  @@index([messageHash])
  @@index([expiresAt])
  @@index([isSpam])
}

model BusinessHours {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String   @unique @db.Uuid
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  timezone       String   @default("UTC")
  mondayStart    String? // "09:00"
  mondayEnd      String? // "17:00"
  tuesdayStart   String?
  tuesdayEnd     String?
  wednesdayStart String?
  wednesdayEnd   String?
  thursdayStart  String?
  thursdayEnd    String?
  fridayStart    String?
  fridayEnd      String?
  saturdayStart  String?
  saturdayEnd    String?
  sundayStart    String?
  sundayEnd      String?
  holidays       Json? // Array of holiday dates
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model WebhookPerformance {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId              String   @db.Uuid
  date                DateTime @default(now())
  totalRequests       Int      @default(0)
  successfulRequests  Int      @default(0)
  failedRequests      Int      @default(0)
  averageResponseTime Int? // Average response time in ms
  triggerBreakdown    Json? // Breakdown by trigger type
  errorBreakdown      Json? // Breakdown of error types
  peakHour            Int? // Hour with most activity (0-23)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// Add these enums
enum TriggerMode {
  KEYWORD
  UNIVERSAL
  AI_SMART
  TIME_BASED
  EVENT_BASED
}

enum CustomerType {
  NEW
  RETURNING
  VIP
  SPAM
}

model ProcessedMessage {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageKey   String   @unique
  createdAt    DateTime @default(now())
  processCount Int      @default(1) // NEW: Track how many times we've seen this message
  updatedAt    DateTime @updatedAt // NEW: Track when it was last updated

  @@index([messageKey])
  @@index([createdAt])
  @@index([processCount]) // NEW: Index for analytics queries
}

model HumanHandoff {
  id               String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String           @db.Uuid
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessId       String           @db.Uuid // NEW: Business isolation
  business         Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  pageId           String // Instagram page ID
  senderId         String // Customer/sender ID
  automationId     String?          @db.Uuid
  automation       Automation?      @relation(fields: [automationId], references: [id], onDelete: SetNull)
  reason           String // Why handoff was initiated
  priority         HandoffPriority  @default(MEDIUM)
  status           HandoffStatus    @default(PENDING)
  context          String?          @db.Text // Conversation context, customer info, etc.
  assignedAgentId  String?          @db.Uuid
  assignedAgent    Agent?           @relation(fields: [assignedAgentId], references: [id], onDelete: SetNull)
  createdAt        DateTime         @default(now())
  assignedAt       DateTime?
  completedAt      DateTime?
  resolution       String?          @db.Text
  customerWaitTime Int? // Time in seconds customer waited for agent
  n8nWorkflowId    String? // ID of n8n workflow that processed this handoff
  n8nExecutionId   String? // ID of n8n execution
  messages         HandoffMessage[]
  notes            HandoffNote[]

  @@index([userId])
  @@index([businessId]) // NEW: Index for business isolation
  @@index([status])
  @@index([priority])
  @@index([assignedAgentId])
  @@index([pageId, senderId])
  @@index([businessId, status]) // NEW: Composite index for business-specific queries
}

model HandoffMessage {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  handoffId       String       @db.Uuid
  handoff         HumanHandoff @relation(fields: [handoffId], references: [id], onDelete: Cascade)
  content         String       @db.Text
  isFromCustomer  Boolean      @default(false)
  isFromAgent     Boolean      @default(false)
  isSystemMessage Boolean      @default(false)
  timestamp       DateTime     @default(now())

  @@index([handoffId])
  @@index([timestamp])
}

model HandoffNote {
  id        String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  handoffId String       @db.Uuid
  handoff   HumanHandoff @relation(fields: [handoffId], references: [id], onDelete: Cascade)
  content   String       @db.Text
  createdBy String // User ID or system
  createdAt DateTime     @default(now())

  @@index([handoffId])
}

model Agent {
  id                  String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String
  email               String                    @unique
  slackUserId         String? // Slack user ID for notifications
  isActive            Boolean                   @default(true)
  isAvailable         Boolean                   @default(true)
  maxConcurrent       Int                       @default(3) // Maximum concurrent handoffs
  skills              String[] // e.g., ["sales", "support", "technical"]
  languages           String[] // e.g., ["en", "es", "fr"]
  timezone            String                    @default("UTC")
  workingHours        Json? // Working hours configuration
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  handoffs            HumanHandoff[]
  businessAssignments AgentBusinessAssignment[] // NEW: Business assignments
  performance         AgentPerformance[] // NEW: Performance tracking

  @@index([isActive, isAvailable])
  @@index([skills])
  @@index([languages])
}

// NEW: Agent-Business assignment model for multi-tenancy
model AgentBusinessAssignment {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agentId    String   @db.Uuid
  agent      Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  businessId String   @db.Uuid
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  isActive   Boolean  @default(true)
  role       String   @default("agent") // agent, supervisor, manager
  assignedAt DateTime @default(now())
  assignedBy String?  @db.Uuid // User who assigned this agent

  @@unique([agentId, businessId])
  @@index([businessId, isActive])
  @@index([agentId, isActive])
}

model HandoffSettings {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String          @unique @db.Uuid
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessId        String          @db.Uuid // NEW: Business reference
  business          Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  isEnabled         Boolean         @default(true)
  notificationEmail String?
  slackWebhookUrl   String?
  slackChannel      String? // Business-specific channel
  teamsWebhookUrl   String?
  n8nWorkflowId     String? // ID of n8n workflow for handoffs
  defaultPriority   HandoffPriority @default(MEDIUM)
  businessHoursOnly Boolean         @default(false)
  autoAssign        Boolean         @default(true)
  maxWaitTime       Int             @default(300) // Max wait time in seconds before escalation
  routingRules      Json? // Business-specific routing rules
  escalationRules   Json? // Escalation rules for this business
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([businessId])
}

model MessageDeliveryLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  pageId      String
  recipientId String
  message     String   @db.Text
  type        String // DM or COMMENT
  success     Boolean
  error       String?
  timestamp   DateTime @default(now())

  @@index([pageId, recipientId])
  @@index([timestamp])
  @@index([success])
}

model ResponseMetrics {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  automationId  String     @db.Uuid
  automation    Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  userId        String     @db.Uuid
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  messageLength Int
  responseTime  Int // in milliseconds
  typingDelay   Int // in milliseconds
  wasSuccessful Boolean
  messageType   String // DM or COMMENT
  hasButtons    Boolean
  sentiment     String? // positive, neutral, negative
  priority      String? // LOW, MEDIUM, HIGH, URGENT
  timestamp     DateTime   @default(now())

  @@index([automationId])
  @@index([userId])
  @@index([timestamp])
}

// NEW: Business-specific agent performance tracking
model AgentPerformance {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agentId              String   @db.Uuid
  agent                Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  businessId           String   @db.Uuid
  business             Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  date                 DateTime @db.Date
  handoffsHandled      Int      @default(0)
  avgResponseTime      Int? // Average response time in seconds
  avgResolutionTime    Int? // Average resolution time in seconds
  customerSatisfaction Float? // Average satisfaction score

  @@unique([agentId, businessId, date])
  @@index([businessId, date])
  @@index([agentId, date])
}

enum HandoffStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  ABANDONED
  TRANSFERRED
}

enum HandoffPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model UserPreferences {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String   @unique @db.Uuid
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  soundEnabled         Boolean  @default(true)
  desktopNotifications Boolean  @default(true)
  emailNotifications   Boolean  @default(false)
  autoMarkAsRead       Boolean  @default(false)
  theme                String   @default("system")
  language             String   @default("en")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("user_preferences")
}

model MessageTracker {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  automationId  String   @db.Uuid
  pageId        String
  senderId      String
  messageCount  Int      @default(0)
  messages      String[]
  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  // Composite unique constraint
  @@unique([automationId, pageId, senderId])
  @@index([automationId])
  @@index([lastMessageAt])
}

model SentimentAnalysis {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  automationId   String   @db.Uuid
  pageId         String
  senderId       String
  sentiment      String // "positive", "negative", "neutral"
  confidence     Float
  messages       String[] // The 4 messages that were analyzed
  sentimentScore Float? // Additional sentiment score
  metrics        String? // JSON string of metrics data
  emotions       String? // JSON string of emotions data
  insights       String? // JSON string of insights data
  metadata       String? // JSON string of metadata
  analyzedAt     DateTime @default(now())

  automation Automation       @relation(fields: [automationId], references: [id], onDelete: Cascade)
  alerts     SentimentAlert[]

  @@index([automationId])
  @@index([analyzedAt])
  @@index([sentiment])
}

model PremiumAnalytics {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String   @db.Uuid
  date                  DateTime @db.Date
  totalAnalyses         Int      @default(0)
  platinumLeads         Int      @default(0)
  goldLeads             Int      @default(0)
  silverLeads           Int      @default(0)
  bronzeLeads           Int      @default(0)
  totalEstimatedRevenue Decimal  @default(0) @db.Decimal(10, 2)
  totalExpectedRevenue  Decimal  @default(0) @db.Decimal(10, 2)
  averageROI            Decimal  @default(0) @db.Decimal(5, 2)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// Revenue metrics for business intelligence
model RevenueMetrics {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String   @db.Uuid
  date                  DateTime @db.Date
  totalEstimatedRevenue Decimal  @default(0) @db.Decimal(10, 2)
  totalExpectedRevenue  Decimal  @default(0) @db.Decimal(10, 2)
  qualifiedLeads        Int      @default(0)
  averageROI            Decimal  @default(0) @db.Decimal(5, 2)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// Revenue opportunities tracking
model RevenueOpportunity {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leadId                String   @db.Uuid
  userId                String   @db.Uuid
  estimatedValue        Decimal  @db.Decimal(10, 2)
  expectedRevenue       Decimal  @db.Decimal(10, 2)
  roi                   Decimal  @db.Decimal(5, 2)
  conversionProbability Decimal  @db.Decimal(3, 2)
  leadTier              String // PLATINUM, GOLD, SILVER, BRONZE
  status                String   @default("ACTIVE") // ACTIVE, CONVERTED, LOST
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relationships
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([leadTier])
  @@index([status])
}

// Scheduled follow-up actions
model ScheduledAction {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leadId       String    @db.Uuid
  action       String // immediate_call, send_proposal, follow_up_call, etc.
  scheduledFor DateTime
  status       String    @default("PENDING") // PENDING, EXECUTED, CANCELLED
  executedAt   DateTime?
  result       String? // Result of the action execution
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relationships
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([scheduledFor])
  @@index([status])
}

model CrmSyncSettings {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String   @unique @db.Uuid
  autoSyncQualified    Boolean  @default(true)
  createDealsHighValue Boolean  @default(true)
  syncLeadScores       Boolean  @default(true)
  realTimeSync         Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relationship to User model
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("CrmSyncSettings")
}

model SentResponse {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recipientKey    String // pageId_senderId_messageType
  responseHash    String // SHA256 hash of response content
  responseContent String // First 1000 chars of response for debugging
  messageType     String // "DM" or "COMMENT"
  automationId    String?
  sentAt          DateTime @default(now())

  @@index([recipientKey])
  @@index([responseHash])
  @@index([sentAt])
  @@index([recipientKey, sentAt])
}

model SentimentAlert {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  automationId      String
  senderId          String
  alertType         String // e.g., "high_risk_customer", "churn_warning", etc.
  sentiment         String // "positive", "negative", "neutral"
  confidence        Float
  riskLevel         String // "low", "medium", "high"
  urgencyLevel      String // "low", "medium", "high"
  satisfactionLevel String // "very_dissatisfied", "dissatisfied", "neutral", "satisfied", "very_satisfied"
  insights          String? // JSON string containing detailed insights
  triggeredAt       DateTime  @default(now())
  resolved          Boolean   @default(false)
  resolvedAt        DateTime?
  resolvedBy        String? // User ID who resolved the alert
  notes             String? // Resolution notes
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  sentimentAnalysis   SentimentAnalysis? @relation(fields: [sentimentAnalysisId], references: [id])
  sentimentAnalysisId String?            @db.Uuid

  @@index([automationId])
  @@index([senderId])
  @@index([riskLevel])
  @@index([resolved])
  @@index([triggeredAt])
  @@map("SentimentAlert")
}

model Alert {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String    @db.Uuid
  type       String // PLATINUM_LEAD, HIGH_VALUE_OPPORTUNITY, etc.
  title      String
  message    String    @db.Text
  priority   String // LOW, MEDIUM, HIGH, URGENT
  leadId     String?   @db.Uuid
  metadata   Json? // Additional alert data
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String?   @db.Uuid
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relationships
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead Lead? @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@index([priority])
  @@index([resolved])
  @@index([createdAt])
}

model GeneralNotification {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String  @db.Uuid
  businessId String? @db.Uuid

  // Notification content
  type    GeneralNotificationType
  title   String
  message String
  isRead  Boolean                 @default(false)

  // Optional metadata and action
  metadata  Json? // Store additional data like IDs, counts, etc.
  actionUrl String? // URL to navigate to when clicked

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  readAt    DateTime? // When the notification was read

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  business Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([businessId])
}

enum GeneralNotificationType {
  LEAD_GENERATED
  LEAD_QUALIFIED
  AUTOMATION_COMPLETED
  AUTOMATION_ERROR
  CAMPAIGN_STARTED
  CAMPAIGN_COMPLETED
  INFLUENCER_APPLIED
  INFLUENCER_ACCEPTED
  WORKFLOW_ACTIVATED
  WORKFLOW_COMPLETED
  WORKFLOW_ASSIGNED
  WORKFLOW_EDIT_REQUEST
  EDIT_REQUESTED
  CRM_SYNC_SUCCESS
  CRM_SYNC_ERROR
  SYSTEM_ALERT
  BUSINESS_UPDATE
}

///////////

model Tenant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid // Reference to your existing User model
  name      String // Business/Organization name
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  domain    String? // Optional custom domain
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  integrations      Integration[]
  voiceflowSessions VoiceflowSession[]
  webhookLogs       WebhookLog[]

  workflows    Workflow[]     // New relation to workflows

  // Indexes
  @@unique([userId])
  @@index([userId])
  @@index([isActive])
}

model Integration {
  id       String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String          @db.Uuid
  type     IntegrationType
  name     String // Display name for the integration
  isActive Boolean         @default(true)

  // Encrypted credentials
  encryptedCredentials String // JSON string of encrypted API keys/tokens
  credentialsHash      String // Hash for integrity checking

  // OAuth specific fields
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?
  scopes         String? // JSON array of scopes

  // Configuration
  config String? // JSON configuration specific to integration type

  capabilities String? @default("{}") // JSON object storing capability toggles

  // Metadata
  lastSyncAt  DateTime?
  lastErrorAt DateTime?
  lastError   String?
  syncCount   Int       @default(0)
  errorCount  Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  apiLogs ApiLog[]

  workflowSteps WorkflowStep[] // New relation to workflow steps

  // Indexes
  @@unique([tenantId, type])
  @@index([tenantId])
  @@index([type])
  @@index([isActive])
}

model VoiceflowSession {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String  @db.Uuid
  sessionId String  @db.Uuid // Voiceflow session ID
  userId    String? // Instagram user ID or other platform user ID
  platform  String  @default("instagram") // instagram, whatsapp, etc.

  // Session data
  variables String? // JSON string of session variables
  context   String? // JSON string of conversation context
  lastStep  String? // Current step in the flow

  // Status tracking
  status       SessionStatus @default(ACTIVE)
  startedAt    DateTime      @default(now())
  lastActiveAt DateTime      @default(now())
  endedAt      DateTime?

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  apiLogs ApiLog[]

  // Indexes
  @@unique([sessionId])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([lastActiveAt])
}

model ApiLog {
  id            String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String? @db.Uuid
  integrationId String? @db.Uuid
  sessionId     String? @db.Uuid

  // Request details
  endpoint       String
  method         String
  requestHeaders String? // JSON
  requestBody    String? // JSON

  // Response details
  statusCode      Int
  responseHeaders String? // JSON
  responseBody    String? // JSON (truncated for large responses)

  // Timing
  duration  Int? // Response time in milliseconds
  timestamp DateTime @default(now())

  // Error handling
  error      String?
  retryCount Int     @default(0)

  // Relations
  integration Integration?      @relation(fields: [integrationId], references: [id], onDelete: SetNull)
  session     VoiceflowSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([tenantId])
  @@index([integrationId])
  @@index([sessionId])
  @@index([timestamp])
  @@index([statusCode])
}

model WebhookLog {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String @db.Uuid
  source    String // stripe, hubspot, etc.
  eventType String // payment.succeeded, contact.created, etc.

  // Webhook data
  headers   String? // JSON
  payload   String // JSON
  signature String? // Webhook signature for verification

  // Processing
  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String?
  retryCount  Int       @default(0)

  timestamp DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId])
  @@index([source])
  @@index([eventType])
  @@index([processed])
  @@index([timestamp])
}

// Enums
enum IntegrationType {
  AIRTABLE
  STRIPE
  HUBSPOT
  SALESFORCE
  PIPEDRIVE
  MAILCHIMP
  SENDGRID
  TWILIO
  SLACK
  ZAPIER
  WEBHOOK
  CALENDLY
  DISCORD
  NOTION
  PAYPAL
  ZOOM
  SHOPIFY
}

enum SessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  EXPIRED
  ERROR
}

///////////////

// Add these models to your existing schema

model WhatsAppAccount {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String    @db.Uuid
  wabaId                String    @unique // WhatsApp Business Account ID
  businessPhoneNumberId String    @unique
  phoneNumber           String
  displayName           String?
  accessToken           String    @db.Text
  refreshToken          String?   @db.Text
  expiresAt             DateTime?
  status                String    @default("pending") // pending, verified, suspended
  webhookToken          String?
  isActive              Boolean   @default(true)

  // Meta app credentials
  appId     String
  appSecret String @db.Text

  // Business verification status
  businessVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user            User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaigns       WhatsAppCampaign[]
  messages        WhatsAppMessage[]
  templates       WhatsAppTemplate[]
  automationRules WhatsAppAutomationRule[]
  contacts        WhatsAppContact[]

  @@map("whatsapp_accounts")
}

model WhatsAppTemplate {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  whatsAppAccountId String  @db.Uuid
  templateName      String
  templateId        String // Meta template ID
  language          String  @default("en")
  category          String // AUTHENTICATION, MARKETING, UTILITY
  status            String // APPROVED, PENDING, REJECTED
  headerType        String? // TEXT, IMAGE, VIDEO, DOCUMENT
  headerText        String? @db.Text
  bodyText          String  @db.Text
  footerText        String? @db.Text
  buttonType        String? // QUICK_REPLY, CALL_TO_ACTION, URL
  buttonText        String?
  buttonUrl         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  whatsAppAccount WhatsAppAccount @relation(fields: [whatsAppAccountId], references: [id], onDelete: Cascade)

  @@unique([whatsAppAccountId, templateName])
  @@map("whatsapp_templates")
}

model WhatsAppMessage {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  whatsAppAccountId String   @db.Uuid
  messageId         String? // Meta message ID
  waId              String // WhatsApp ID of recipient
  phoneNumber       String
  contactName       String?
  messageType       String // text, template, image, document, etc.
  content           String   @db.Text
  templateName      String?
  direction         String // inbound, outbound
  status            String // sent, delivered, read, failed
  timestamp         DateTime @default(now())

  // Automation context - Fixed to use String @db.Uuid
  campaignId       String? @db.Uuid
  automationRuleId String? @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  whatsAppAccount WhatsAppAccount         @relation(fields: [whatsAppAccountId], references: [id], onDelete: Cascade)
  campaign        WhatsAppCampaign?       @relation(fields: [campaignId], references: [id])
  automationRule  WhatsAppAutomationRule? @relation(fields: [automationRuleId], references: [id])

  @@map("whatsapp_messages")
}

model WhatsAppContact {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  whatsAppAccountId String    @db.Uuid
  waId              String // WhatsApp ID
  phoneNumber       String
  name              String?
  profileName       String?
  lastSeen          DateTime?
  isBlocked         Boolean   @default(false)
  tags              String[] // For segmentation
  customFields      Json? // Store additional contact data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  whatsAppAccount WhatsAppAccount @relation(fields: [whatsAppAccountId], references: [id], onDelete: Cascade)

  @@unique([whatsAppAccountId, waId])
  @@map("whatsapp_contacts")
}

model WhatsAppCampaign {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  whatsAppAccountId String    @db.Uuid
  name              String
  description       String?
  templateId        String?
  targetAudience    Json // Criteria for targeting
  scheduledAt       DateTime?
  status            String    @default("draft") // draft, scheduled, running, completed, paused
  totalTargets      Int       @default(0)
  sentCount         Int       @default(0)
  deliveredCount    Int       @default(0)
  readCount         Int       @default(0)
  failedCount       Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  whatsAppAccount WhatsAppAccount   @relation(fields: [whatsAppAccountId], references: [id], onDelete: Cascade)
  messages        WhatsAppMessage[]

  @@map("whatsapp_campaigns")
}

model WhatsAppAutomationRule {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  whatsAppAccountId String  @db.Uuid
  name              String
  description       String?
  trigger           String // keyword, welcome, business_hours, etc.
  triggerValue      String? // specific keyword or condition
  isActive          Boolean @default(true)

  // Response configuration
  responseType       String // text, template, transfer
  responseContent    String  @db.Text
  responseTemplateId String?
  delayMinutes       Int     @default(0)

  // Conditions
  businessHoursOnly Boolean @default(false)
  maxResponses      Int? // Limit responses per contact

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  whatsAppAccount WhatsAppAccount   @relation(fields: [whatsAppAccountId], references: [id], onDelete: Cascade)
  messages        WhatsAppMessage[]

  @@map("whatsapp_automation_rules")
}

model WhatsAppWebhookLog {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  whatsAppAccountId String? @db.Uuid
  eventType         String
  payload           Json
  processed         Boolean @default(false)
  processingError   String? @db.Text

  createdAt DateTime @default(now())

  @@map("whatsapp_webhook_logs")
}

//For the new tools interface

model Workflow {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @db.Uuid
  name        String
  description String?
  isActive    Boolean  @default(false)
  
  // AI-generated metadata
  aiPrompt    String?  // Original user prompt used to generate workflow
  aiGenerated Boolean  @default(false)
  
  // Execution settings
  maxRetries     Int     @default(3)
  timeoutSeconds Int     @default(300)
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  tenant     Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  steps      WorkflowStep[]
  conditions WorkflowCondition[]
  executions WorkflowExecution[]
  
  // Indexes
  @@index([tenantId])
  @@index([isActive])
}

model WorkflowStep {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workflowId String @db.Uuid
  
  // Step identification
  stepId   String // Unique within workflow for referencing
  stepType String // 'trigger', 'action', 'condition'
  
  // Integration reference
  integrationId   String @db.Uuid
  integrationName String
  capabilityId    String
  capabilityName  String
  
  // Configuration
  config String @default("{}") // JSON configuration for this step
  
  // Visual positioning for drag-drop
  positionX Int @default(0)
  positionY Int @default(0)
  stepOrder Int @default(0)
  
  // Conditional logic
  parentStepId String? // For branching workflows
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  workflow    Workflow     @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  integration Integration  @relation(fields: [integrationId], references: [id])
  
  // Indexes
  @@index([workflowId])
  @@index([integrationId])
  @@index([stepOrder])
}

model WorkflowCondition {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workflowId String @db.Uuid
  
  // Condition identification
  conditionId String // Unique within workflow
  
  // Condition logic
  field        String // Field to check
  operator     String // 'equals', 'not_equals', 'contains', 'greater_than', 'less_than'
  value        String // Value to compare against
  
  // Branching
  trueStepId  String? // Step to execute if condition is true
  falseStepId String? // Step to execute if condition is false
  
  createdAt DateTime @default(now())
  
  // Relations
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([workflowId])
}

model WorkflowExecution {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workflowId String @db.Uuid
  
  // Execution status
  status       String    // 'pending', 'running', 'completed', 'failed', 'cancelled'
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  
  // Error handling
  errorMessage String?
  errorStep    String? // Step ID where error occurred
  retryCount   Int     @default(0)
  
  // Execution data
  inputData    String  @default("{}") // JSON input data
  outputData   String  @default("{}") // JSON output data
  executionLog String  @default("[]") // JSON array of execution steps
  
  // Metadata
  triggeredBy String? // What triggered this execution
  
  // Relations
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
}












/////////////////////// workflows

model SocialAccount {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @db.Uuid
  platform     String   // "instagram", "twitter", "facebook", "tiktok", etc.
  accountId    String   // Platform-specific account ID
  username     String
  accessToken  String?  // Encrypted access token
  refreshToken String?  // Encrypted refresh token
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Workflows using this account
  workflows Workflows[]

  @@unique([userId, platform, accountId])
  @@map("social_accounts")
}

model Workflows {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @db.Uuid
  name        String
  description String?
  isActive    Boolean  @default(false)
  
  // Social media configuration
  socialAccountId String?  @db.Uuid // Fixed: Added @db.Uuid
  triggerType     String   // "dm", "comment", "mention", "story_reply"
  
  // Workflow data
  nodes       Json     // Serialized workflow nodes
  connections Json     // Node connections
  variables   Json?    // Custom variables
  
  // Metadata
  version     String   @default("1.0.0")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastRunAt   DateTime?

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  socialAccount SocialAccount? @relation(fields: [socialAccountId], references: [id])
  
  // Executions and analytics
  executions WorkflowExecutions[]
  analytics  WorkflowAnalytics[]

  @@map("workflows")
}

model WorkflowExecutions {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workflowId String   @db.Uuid
  
  // Trigger information
  triggerData Json     // Original message/comment data
  platform    String   // "instagram", "twitter", etc.
  senderId    String   // Platform user ID who triggered
  senderUsername String?
  
  // Execution details
  status      String   // "running", "completed", "failed", "stopped"
  startedAt   DateTime @default(now())
  completedAt DateTime?
  errorMessage String?
  
  // Execution path
  executedNodes Json    // Array of executed node IDs with timestamps
  currentNode   String? // Current node being executed
  
  // Response data
  responses Json?      // Generated responses sent
  
  workflow Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@map("workflow_executions")
}

model WorkflowAnalytics {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @db.Uuid
  workflowId String   @db.Uuid // Fixed: Added @db.Uuid
  
  // Time period
  date       DateTime @default(now())
  
  // Metrics
  executions    Int @default(0)
  completions   Int @default(0)
  failures      Int @default(0)
  avgDuration   Float? // Average execution time in seconds
  
  // Engagement metrics
  responses     Int @default(0)
  buttonClicks  Int @default(0)
  conversions   Int @default(0)
  
  // Platform breakdown
  platformStats Json? // Stats per platform
  
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflow Workflows @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([userId, workflowId, date])
  @@map("workflow_analytics")
}

model Template {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String
  category    String   // "ecommerce", "customer_service", "lead_generation", etc.
  
  // Template data
  nodes       Json     // Pre-built workflow nodes
  connections Json     // Node connections
  variables   Json?    // Template variables
  
  // Metadata
  isPublic    Boolean  @default(true)
  usageCount  Int      @default(0)
  rating      Float?   // Average user rating
  tags        String[] // Searchable tags
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("templates")
}

model ApiIntegration {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @db.Uuid
  name        String
  type        String   // "webhook", "rest_api", "graphql", etc.
  
  // Configuration
  endpoint    String
  method      String?  // "GET", "POST", "PUT", "DELETE"
  headers     Json?    // Custom headers
  authType    String?  // "none", "bearer", "api_key", "oauth"
  authConfig  Json?    // Auth configuration (encrypted)
  
  // Usage
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation("UserApiIntegrations", fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_integrations")
}

model MessageTemplates {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @db.Uuid
  name        String
  content     String
  type        String   // "text", "image", "video", "carousel"
  
  // Template variables
  variables   Json?    // Available variables like {{name}}, {{product}}
  
  // Usage tracking
  usageCount  Int      @default(0)
  lastUsedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation("UserMessageTemplates", fields: [userId], references: [id], onDelete: Cascade)

  @@map("message_templates")
}


























































// ============================================================================
// LINKEDIN MODELS
// ============================================================================

model LinkedInAccount {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String    @db.Uuid
  
  // LinkedIn OAuth credentials
  linkedInId            String    @unique
  accessToken           String    @db.Text
  refreshToken          String?   @db.Text
  expiresAt             DateTime?
  
  // Account metadata
  profileUrl            String?
  firstName             String?
  lastName              String?
  headline              String?
  profilePicture        String?
  
  // Webhook configuration
  webhookToken          String?   @unique
  
  // Status and tracking
  status                String    @default("pending") // pending, verified, suspended, inactive
  isActive              Boolean   @default(true)
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  user                  User      @relation("LinkedInAccounts", fields: [userId], references: [id], onDelete: Cascade)
  messages              LinkedInMessage[]
  contacts              LinkedInContact[]
  campaigns             LinkedInCampaign[]
  automationRules       LinkedInAutomationRule[]
  webhookLogs           LinkedInWebhookLog[]
  
  @@index([userId])
  @@index([status])
  @@index([isActive])
  @@map("linkedin_accounts")
}

model LinkedInMessage {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  linkedInAccountId     String    @db.Uuid
  
  // Message identifiers
  messageId             String?
  conversationId        String
  
  // Message content
  senderId              String
  recipientId           String
  content               String    @db.Text
  messageType           String    @default("text") // text, image, video, document, template
  
  // Message metadata
  direction             String    @default("inbound") // inbound, outbound
  status                String    @default("sent") // sent, delivered, read, failed
  
  // Tracking
  campaignId            String?   @db.Uuid
  automationRuleId      String?   @db.Uuid
  
  // Timestamps
  timestamp             DateTime  @default(now())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  linkedInAccount       LinkedInAccount @relation(fields: [linkedInAccountId], references: [id], onDelete: Cascade)
  campaign              LinkedInCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  automationRule        LinkedInAutomationRule? @relation(fields: [automationRuleId], references: [id], onDelete: SetNull)
  
  @@index([linkedInAccountId])
  @@index([conversationId])
  @@index([senderId])
  @@index([recipientId])
  @@index([status])
  @@index([direction])
  @@map("linkedin_messages")
}

model LinkedInContact {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  linkedInAccountId     String    @db.Uuid
  
  // Contact identifiers
  linkedInId            String
  profileUrl            String?
  
  // Contact information
  firstName             String
  lastName              String
  headline              String?
  company               String?
  industry              String?
  location              String?
  profilePicture        String?
  
  // Relationship status
  connectionStatus      String    @default("not_connected") // not_connected, pending, connected
  
  // Engagement tracking
  tags                  String[]  @default([])
  customFields          Json?
  lastMessageAt         DateTime?
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  linkedInAccount       LinkedInAccount @relation(fields: [linkedInAccountId], references: [id], onDelete: Cascade)
  
  @@index([linkedInAccountId])
  @@index([linkedInId])
  @@index([connectionStatus])
  @@unique([linkedInAccountId, linkedInId])
  @@map("linkedin_contacts")
}

model LinkedInCampaign {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  linkedInAccountId     String    @db.Uuid
  
  // Campaign metadata
  name                  String
  description           String?   @db.Text
  campaignType          String    @default("outreach") // outreach, nurture, engagement
  
  // Targeting
  targetAudience        Json      // { industries: [], titles: [], companies: [], locations: [] }
  messageTemplate       String    @db.Text
  
  // Campaign status
  status                String    @default("draft") // draft, scheduled, running, paused, completed
  scheduledAt           DateTime?
  startedAt             DateTime?
  completedAt           DateTime?
  
  // Metrics
  totalTargets          Int       @default(0)
  sentCount             Int       @default(0)
  deliveredCount        Int       @default(0)
  readCount             Int       @default(0)
  repliedCount          Int       @default(0)
  failedCount           Int       @default(0)
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  linkedInAccount       LinkedInAccount @relation(fields: [linkedInAccountId], references: [id], onDelete: Cascade)
  messages              LinkedInMessage[]
  
  @@index([linkedInAccountId])
  @@index([status])
  @@index([campaignType])
  @@map("linkedin_campaigns")
}

model LinkedInAutomationRule {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  linkedInAccountId     String    @db.Uuid
  
  // Rule configuration
  name                  String
  trigger               String    // connection_request, profile_view, message_keyword, welcome_message
  triggerValue          String?   @db.Text // keyword or condition
  
  // Response configuration
  responseType          String    @default("text") // text, template, transfer
  responseContent       String    @db.Text
  
  // Rule settings
  isActive              Boolean   @default(true)
  businessHoursOnly     Boolean   @default(false)
  priority              Int       @default(0)
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  linkedInAccount       LinkedInAccount @relation(fields: [linkedInAccountId], references: [id], onDelete: Cascade)
  messages              LinkedInMessage[]
  
  @@index([linkedInAccountId])
  @@index([trigger])
  @@index([isActive])
  @@map("linkedin_automation_rules")
}

model LinkedInWebhookLog {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  linkedInAccountId     String?   @db.Uuid
  
  // Webhook event
  eventType             String
  payload               Json
  
  // Processing
  processed             Boolean   @default(false)
  processingError       String?   @db.Text
  
  // Timestamps
  createdAt             DateTime  @default(now())
  
  // Relations
  linkedInAccount       LinkedInAccount? @relation(fields: [linkedInAccountId], references: [id], onDelete: Cascade)
  
  @@index([linkedInAccountId])
  @@index([eventType])
  @@index([processed])
  @@map("linkedin_webhook_logs")
}

// ============================================================================
// FACEBOOK MODELS
// ============================================================================

model FacebookPage {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String    @db.Uuid
  
  // Facebook credentials
  pageId                String    @unique
  accessToken           String    @db.Text
  refreshToken          String?   @db.Text
  expiresAt             DateTime?
  
  // Page metadata
  pageName              String
  category              String?
  profilePicture        String?
  isVerified            Boolean   @default(false)
  
  // Webhook configuration
  webhookToken          String?   @unique
  
  // Status and tracking
  status                String    @default("pending") // pending, verified, suspended, inactive
  isActive              Boolean   @default(true)
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  user                  User      @relation("FacebookPages", fields: [userId], references: [id], onDelete: Cascade)
  messages              FacebookMessage[]
  contacts              FacebookContact[]
  campaigns             FacebookCampaign[]
  automationRules       FacebookAutomationRule[]
  webhookLogs           FacebookWebhookLog[]
  comments              FacebookComment[]
  
  @@index([userId])
  @@index([status])
  @@index([isActive])
  @@map("facebook_pages")
}

model FacebookMessage {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facebookPageId        String    @db.Uuid
  
  // Message identifiers
  messageId             String?
  conversationId        String
  
  // Message content
  senderId              String
  recipientId           String
  content               String    @db.Text
  messageType           String    @default("text") // text, image, video, template, quick_reply
  
  // Message metadata
  direction             String    @default("inbound") // inbound, outbound
  status                String    @default("sent") // sent, delivered, read, failed
  source                String    @default("messenger") // messenger, comment_reply
  
  // Tracking
  campaignId            String?   @db.Uuid
  automationRuleId      String?   @db.Uuid
  
  // Timestamps
  timestamp             DateTime  @default(now())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  facebookPage          FacebookPage @relation(fields: [facebookPageId], references: [id], onDelete: Cascade)
  campaign              FacebookCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  automationRule        FacebookAutomationRule? @relation(fields: [automationRuleId], references: [id], onDelete: SetNull)
  
  @@index([facebookPageId])
  @@index([conversationId])
  @@index([senderId])
  @@index([recipientId])
  @@index([status])
  @@index([source])
  @@map("facebook_messages")
}

model FacebookContact {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facebookPageId        String    @db.Uuid
  
  // Contact identifiers
  facebookUserId        String
  
  // Contact information
  name                  String?
  email                 String?
  phone                 String?
  profilePicture        String?
  
  // Engagement tracking
  tags                  String[]  @default([])
  customFields          Json?
  lastMessageAt         DateTime?
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  facebookPage          FacebookPage @relation(fields: [facebookPageId], references: [id], onDelete: Cascade)
  
  @@index([facebookPageId])
  @@index([facebookUserId])
  @@unique([facebookPageId, facebookUserId])
  @@map("facebook_contacts")
}

model FacebookComment {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facebookPageId        String    @db.Uuid
  
  // Comment identifiers
  commentId             String    @unique
  postId                String
  
  // Comment content
  userId                String
  content               String    @db.Text
  
  // Comment hierarchy
  parentCommentId       String?
  
  // Status
  status                String    @default("pending") // pending, replied, archived
  repliedAt             DateTime?
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  facebookPage          FacebookPage @relation(fields: [facebookPageId], references: [id], onDelete: Cascade)
  
  @@index([facebookPageId])
  @@index([postId])
  @@index([userId])
  @@index([status])
  @@map("facebook_comments")
}

model FacebookCampaign {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facebookPageId        String    @db.Uuid
  
  // Campaign metadata
  name                  String
  description           String?   @db.Text
  campaignType          String    @default("messenger") // messenger, comment_reply, broadcast
  
  // Targeting
  targetAudience        Json      // { interests: [], demographics: [], behaviors: [] }
  messageTemplate       String    @db.Text
  
  // Campaign status
  status                String    @default("draft") // draft, scheduled, running, paused, completed
  scheduledAt           DateTime?
  startedAt             DateTime?
  completedAt           DateTime?
  
  // Metrics
  totalTargets          Int       @default(0)
  sentCount             Int       @default(0)
  deliveredCount        Int       @default(0)
  readCount             Int       @default(0)
  repliedCount          Int       @default(0)
  failedCount           Int       @default(0)
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  facebookPage          FacebookPage @relation(fields: [facebookPageId], references: [id], onDelete: Cascade)
  messages              FacebookMessage[]
  
  @@index([facebookPageId])
  @@index([status])
  @@index([campaignType])
  @@map("facebook_campaigns")
}

model FacebookAutomationRule {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facebookPageId        String    @db.Uuid
  
  // Rule configuration
  name                  String
  trigger               String    // message_keyword, comment_keyword, welcome_message, comment_reply
  triggerValue          String?   @db.Text // keyword or condition
  
  // Response configuration
  responseType          String    @default("text") // text, template, transfer
  responseContent       String    @db.Text
  
  // Rule settings
  isActive              Boolean   @default(true)
  businessHoursOnly     Boolean   @default(false)
  priority              Int       @default(0)
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  facebookPage          FacebookPage @relation(fields: [facebookPageId], references: [id], onDelete: Cascade)
  messages              FacebookMessage[]
  
  @@index([facebookPageId])
  @@index([trigger])
  @@index([isActive])
  @@map("facebook_automation_rules")
}

model FacebookWebhookLog {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  facebookPageId        String?   @db.Uuid
  
  // Webhook event
  eventType             String
  payload               Json
  
  // Processing
  processed             Boolean   @default(false)
  processingError       String?   @db.Text
  
  // Timestamps
  createdAt             DateTime  @default(now())
  
  // Relations
  facebookPage          FacebookPage? @relation(fields: [facebookPageId], references: [id], onDelete: Cascade)
  
  @@index([facebookPageId])
  @@index([eventType])
  @@index([processed])
  @@map("facebook_webhook_logs")
}
